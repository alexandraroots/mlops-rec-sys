# mlops-reс-sys

## Сервис рекомендаций (gRPC + Docker)
Cервис рекомендаций, реализованный на Python (gRPC).
Сервис получает историю просмотренных товаров (user_history) и возвращает рекомендованные item_ids.

### Локальный запуск

1. Сборка Docker-образа

```bash
docker build -t mlops-rec-sys -f docker/Dockerfile .
```

2. Запуск сервиса
```bash
docker run -d --name mlops-server -p 50051:50051 -p 8000:8000 mlops-rec-sys
```

3. Или через docker-compose
```bash
docker-compose -f docker/docker-compose.yml up --build
```

- gRPC API доступен на localhost:50051
- Метрики Prometheus доступны на localhost:8000/metrics
- Prometheus доступен на localhost:9090
- Grafana доступна на localhost:3000

### Проверка работоспособности

1. gRPC-запрос с помощью grpcurl

```bash
grpcurl -plaintext \
  -import-path ./ \
  -proto src/mlops_rec_sys/proto/recommendation.proto \
  -d '{"item_ids":[1, 2, 3, 10, 15]}' \
  localhost:50051 \
  Recommender/Recommend
```

Пример ответа:

```json
{
  "item_ids": [101, 102, 103]
}

```

2. Тестовый Python-клиент

```bash
python src/mlops_rec_sys/client.py localhost:50051
```

### Архитектура
Общая структура проекта

```text
mlops-rec-sys/
├── 📁 docker/                 # Docker-ориентированная конфигурация
├── 📁 models/                 # Хранилище версий ONNX моделей
├── 📁 src/mlops_rec_sys/
│   ├── 📁 proto/             # gRPC контракты и сгенерированный код
│   ├── 🔧 client.py          # gRPC клиент для тестирования
│   └── 🚀 server.py          # Основной gRPC сервер
├── 📁 scripts/               # Утилиты и скрипты
├── 📁 tests/                 # Тестовое покрытие
└── 📁 .github/workflows/     # CI/CD пайплайны
```

### Схема работы

```text
┌─────────────────┐    gRPC запрос    ┌─────────────────────┐
│   gRPC Клиент   │ ────────────────► │   gRPC Сервер       │
│                 │                   │  (Python + ONNX)    │
└─────────────────┘                   ├─────────────────────┤
                                      │  █ Порты:           │
                                      │  • 50051 - gRPC     │
                                      │  • 8000 - Метрики   │
┌─────────────────┐    Ответ          └──────────┬──────────┘
│   Prometheus    │ ◄────────────────────────────┤
│   (Метрики)     │                               │
└─────────────────┘                               │
                                      ┌───────────▼──────────────┐
                                      │   ONNX Модель            │
                                      │  █ recommendation_model.onnx
                                      └────────────────────────┘
```

### Мониторинг

Prometheus собирает метрики с сервиса (/metrics).
Grafana подключается к Prometheus и отображает дашборды:

- grpc_request_duration_seconds - время обработки запросов
- grpc_requests_total - счетчик запросов по статусам
- grpc_requests_in_progress - активные запросы

## Предложения по масштабированию и контролю версий модели

### Model Registry и версионирование

```text
# Текущее
models/
├── recommendation_model.onnx

# Целевое
models/
├── registry.json                    # Метаданные всех моделей
├── production -> v1.2.3/           # Symbolic link
├── staging -> v1.3.0-beta/         # Symbolic link
├── v1.2.3/
│   ├── model.onnx
│   ├── metadata.json
│   └── metrics.json
├── v1.3.0-beta/
│   ├── model.onnx
│   └── metadata.json
└── archive/
    ├── v1.2.2/
    └── v1.1.0/
```

### A/B тестирование

```text
┌─────────────────────────────────────────────────────────────┐
│                    ВХОДЯЩИЙ ТРАФИК                         │
│                    1000 запросов/сек                       │
└─────────────────────────────┬───────────────────────────────┘
                              │
                  ┌───────────┼───────────┐
                  │                       │
          70% трафика             30% трафика
                  │                       │
          ┌───────▼───────┐       ┌───────▼───────┐
          │  КОНТРОЛЬНАЯ  │       │  ЭКСПЕРИМЕНТ  │
          │    ГРУППА     │       │    ГРУППА     │
          │               │       │               │
          │ • Модель v1.2 │       │ • Модель v1.3 │
          │ • 700 RPS     │       │ • 300 RPS     │
          └───────┬───────┘       └───────┬───────┘
                  │                       │
                  └───────────┬───────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    СБОР МЕТРИК                             │
│  • CTR (Click-Through Rate)                                │
│  • Conversion Rate                                         │
│  • Response Time                                           │
│  • Revenue per User                                        │
└─────────────────────────────────────────────────────────────┘
```

### Детальная схема A/B тестирования

```text
┌─────────────────┐    Запрос    ┌─────────────────────────────┐
│    КЛИЕНТ       │ ────────────►│    A/B ТЕСТ СЕРВИС          │
│                 │              ├─────────────────────────────┤
└─────────────────┘              │ 1. Анализ user_id          │
                                 │ 2. Определение группы      │
                                 │ 3. Выбор модели            │
                                 └─────────────┬───────────────┘
                                               │
                         ┌─────────────────────┼─────────────────────┐
                         │                     │                     │
                Группа A │            Группа B │            Группа C │
                 (70%)   │             (20%)   │             (10%)   │
                         │                     │                     │
                ┌────────▼────────┐   ┌────────▼────────┐   ┌────────▼────────┐
                │   МОДЕЛЬ v1.2   │   │   МОДЕЛЬ v1.3   │   │   МОДЕЛЬ v1.4   │
                │   (Контроль)    │   │  (Эксперимент)  │   │  (Каннари)      │
                └────────┬────────┘   └────────┬────────┘   └────────┬────────┘
                         │                     │                     │
                         └─────────────────────┼─────────────────────┘
                                               │
                                 ┌─────────────▼─────────────┐
                                 │   СИСТЕМА ЛОГИРОВАНИЯ    │
                                 │  • User ID               │
                                 │  • Группа теста          │
                                 │  • Модель версия         │
                                 │  • Результаты            │
                                 └─────────────┬─────────────┘
                                               │
                                 ┌─────────────▼─────────────┐
                                 │    АНАЛИТИЧЕСКАЯ          │
                                 │       ПЛАТФОРМА          │
                                 │  • Статистический анализ │
                                 │  • Dashboard             │
                                 │  • Автоматические выводы │
                                 └───────────────────────────┘
```